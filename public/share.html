<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Antigravity API - å…±äº«ä¸­å¿ƒ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #8b5cf6;
      --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
      --dark: #1e293b; --light: #f8fafc; --gray: #64748b; --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f0f4ff 0%, #faf5ff 50%, #fef3f2 100%); min-height: 100vh; color: var(--dark); line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .header { background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%); padding: 40px; border-radius: 24px; box-shadow: var(--shadow-lg); margin-bottom: 32px; text-align: center; }
    .header h1 { color: white; font-size: 2.2em; font-weight: 700; margin-bottom: 12px; }
    .header p { color: rgba(255, 255, 255, 0.95); font-size: 1.15em; max-width: 600px; margin: 0 auto; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow); text-align: center; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
    .stat-card h4 { color: var(--gray); font-size: 0.85em; margin-bottom: 8px; text-transform: uppercase; font-weight: 600; }
    .stat-value { font-size: 2.2em; font-weight: 700; background: linear-gradient(135deg, var(--success) 0%, #059669 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .card { background: white; padding: 28px; border-radius: 16px; margin-bottom: 24px; box-shadow: var(--shadow); }
    .card h3 { color: var(--dark); margin-bottom: 20px; font-size: 1.3em; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .token-item { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 20px; margin-bottom: 14px; border-radius: 12px; border: 2px solid var(--border); transition: all 0.2s; }
    .token-item:hover { border-color: var(--success); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1); }
    .token-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .token-owner { font-weight: 600; color: var(--dark); font-size: 1.05em; }
    .token-email { color: var(--gray); font-size: 0.85em; margin-top: 2px; }
    .progress-container { margin-top: 12px; }
    .progress-label { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85em; color: var(--gray); }
    .progress-bar-bg { background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--success) 0%, #059669 100%); transition: width 0.3s ease; border-radius: 5px; }
    .status-badge { padding: 5px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 600; }
    .status-available { background: #d1fae5; color: #065f46; }
    .status-limited { background: #fef3c7; color: #92400e; }
    .status-full { background: #fee2e2; color: #991b1b; }
    .empty-state { text-align: center; padding: 50px 20px; color: var(--gray); }
    .empty-state h3 { font-size: 1.2em; margin-bottom: 8px; color: var(--dark); }
    .alert { padding: 14px 18px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: flex-start; gap: 12px; }
    .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
    .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .nav-link { display: inline-block; margin: 10px 8px; padding: 12px 24px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; text-decoration: none; border-radius: 10px; font-weight: 600; transition: all 0.2s; }
    .nav-link:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); }
    .vote-item { background: #f8fafc; padding: 18px; border-radius: 12px; margin-bottom: 14px; border: 1px solid var(--border); }
    .vote-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
    .vote-target { font-weight: 600; color: var(--dark); }
    .vote-reason { color: var(--gray); font-size: 0.9em; margin-top: 4px; }
    .vote-meta { font-size: 0.8em; color: var(--gray); }
    .vote-actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    .btn { padding: 8px 16px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.9em; }
    .btn-danger { background: #fee2e2; color: #991b1b; }
    .btn-danger:hover { background: #fecaca; }
    .btn-success { background: #d1fae5; color: #065f46; }
    .btn-success:hover { background: #a7f3d0; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .vote-stats { display: flex; gap: 12px; margin-top: 10px; font-size: 0.85em; flex-wrap: wrap; }
    .vote-stats span { padding: 4px 10px; border-radius: 6px; }
    .comments-section { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
    .comment-item { background: white; padding: 10px 14px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9em; }
    .comment-author { font-weight: 600; color: var(--primary); }
    .comment-time { font-size: 0.8em; color: var(--gray); margin-left: 8px; }
    .comment-input { display: flex; gap: 10px; margin-top: 10px; }
    .comment-input input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9em; }
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 20px; border: none; background: #e2e8f0; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .tab-btn.active { background: var(--primary); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .countdown { font-size: 0.85em; color: var(--warning); font-weight: 600; }
    @media (max-width: 768px) { .header h1 { font-size: 1.8em; } .header p { font-size: 1em; } .token-header, .vote-header { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Token å…±äº«ä¸­å¿ƒ</h1>
      <p>ç¤¾åŒºç”¨æˆ·åˆ†äº«çš„ Google Tokenï¼Œè®©æ‰€æœ‰äººéƒ½èƒ½ä½¿ç”¨ AI æœåŠ¡</p>
    </div>

    <!-- å°ç¦çŠ¶æ€æç¤º -->
    <div id="banAlert" class="alert alert-danger" style="display: none;">
      <div>
        <strong>å…±äº«å·²ç¦ç”¨</strong><br>
        <span id="banReason"></span><br>
        <span id="banTime"></span>
      </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card"><h4>å…±äº« Token</h4><div class="stat-value" id="totalShared">0</div></div>
      <div class="stat-card"><h4>å¯ç”¨</h4><div class="stat-value" id="totalAvailable">0</div></div>
      <div class="stat-card"><h4>ä»Šæ—¥é™é¢</h4><div class="stat-value" id="totalLimit">0</div></div>
      <div class="stat-card"><h4>ä»Šæ—¥å·²ç”¨</h4><div class="stat-value" id="totalUsed">0</div></div>
      <div class="stat-card"><h4>æ´»è·ƒæŠ•ç¥¨</h4><div class="stat-value" id="activeVotesCount">0</div></div>
    </div>

    <!-- è¯´æ˜ -->
    <div class="alert alert-info">
      <div>
        <strong>ä»€ä¹ˆæ˜¯ Token å…±äº«ï¼Ÿ</strong><br>
        ç¤¾åŒºç”¨æˆ·è‡ªæ„¿åˆ†äº« Google Tokenï¼Œè®©æ²¡æœ‰ Token çš„ç”¨æˆ·ä¹Ÿèƒ½ä½¿ç”¨ AI æœåŠ¡ã€‚å‘ç°æ»¥ç”¨å¯å‘èµ·æŠ•ç¥¨å°ç¦ã€‚å‰å¾€ <a href="/user.html" style="color: var(--primary); font-weight: 600;">ç”¨æˆ·ä¸­å¿ƒ</a> å…±äº«æ‚¨çš„ Tokenã€‚
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('tokens')">Token åˆ—è¡¨</button>
      <button class="tab-btn" onclick="switchTab('usage')">ç”¨æˆ·ç»Ÿè®¡</button>
      <button class="tab-btn" onclick="switchTab('votes')">æŠ•ç¥¨å°ç¦</button>
      <button class="tab-btn" onclick="switchTab('history')">æŠ•ç¥¨å†å²</button>
    </div>

    <!-- Token åˆ—è¡¨ -->
    <div id="tokens" class="tab-content active">
      <div class="card">
        <h3>å…±äº« Token åˆ—è¡¨</h3>
        <div id="tokenList"><div class="empty-state"><h3>æ­£åœ¨åŠ è½½...</h3></div></div>
      </div>
    </div>

    <!-- ç”¨æˆ·ä½¿ç”¨ç»Ÿè®¡ -->
    <div id="usage" class="tab-content">
      <div class="card">
        <h3>ğŸ“Š ç”¨æˆ·ä½¿ç”¨ç»Ÿè®¡</h3>
        <p style="color: var(--gray); margin-bottom: 20px; font-size: 0.9em;">æ˜¾ç¤ºæ‰€æœ‰ä½¿ç”¨å…±äº«Tokençš„ç”¨æˆ·åŠå…¶ä½¿ç”¨æƒ…å†µ</p>
        <div id="userUsageList"><div class="empty-state"><h3>æ­£åœ¨åŠ è½½...</h3></div></div>
      </div>
    </div>

    <!-- æ´»è·ƒæŠ•ç¥¨ -->
    <div id="votes" class="tab-content">
      <div class="card">
        <h3>
          æ´»è·ƒæŠ•ç¥¨
          <button class="btn btn-primary" onclick="showCreateVoteModal()" style="margin-left: auto; font-size: 0.85em;">å‘èµ·æŠ•ç¥¨</button>
        </h3>
        <div id="activeVoteList"><div class="empty-state"><h3>æš‚æ— æ´»è·ƒæŠ•ç¥¨</h3><p>ç¤¾åŒºç›®å‰æ²¡æœ‰è¿›è¡Œä¸­çš„å°ç¦æŠ•ç¥¨</p></div></div>
      </div>
    </div>

    <!-- æŠ•ç¥¨å†å² -->
    <div id="history" class="tab-content">
      <div class="card">
        <h3>æŠ•ç¥¨å†å²</h3>
        <div id="voteHistory"><div class="empty-state"><h3>æš‚æ— æŠ•ç¥¨è®°å½•</h3></div></div>
      </div>
    </div>

    <!-- è¿”å›é“¾æ¥ -->
    <div style="text-align: center; margin-top: 20px;">
      <a href="/user.html" class="nav-link">å‰å¾€ç”¨æˆ·ä¸­å¿ƒ</a>
      <a href="/" class="nav-link">ç®¡ç†å‘˜å…¥å£</a>
    </div>
  </div>

  <!-- å‘èµ·æŠ•ç¥¨å¼¹çª— -->
  <div id="voteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; margin: 20px;">
      <h3 style="margin-bottom: 20px;">å‘èµ·å°ç¦æŠ•ç¥¨</h3>
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600;">ç›®æ ‡ç”¨æˆ·å</label>
        <input type="text" id="voteTargetUser" placeholder="è¾“å…¥è¦ä¸¾æŠ¥çš„ç”¨æˆ·å" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600;">ä¸¾æŠ¥åŸå› </label>
        <textarea id="voteReason" placeholder="è¯·è¯¦ç»†è¯´æ˜ä¸¾æŠ¥åŸå› ..." rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; resize: vertical;"></textarea>
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn" style="background: #e2e8f0;" onclick="hideCreateVoteModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitVote()">æäº¤æŠ•ç¥¨</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let userToken = localStorage.getItem('userToken');

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
      if (tabName === 'votes') loadActiveVotes();
      if (tabName === 'history') loadVoteHistory();
      if (tabName === 'usage') loadUserUsage();
    }

    async function loadBanStatus() {
      if (!userToken) return;
      try {
        const response = await fetch(`${API_BASE}/admin/shared/status`, { headers: { 'X-User-Token': userToken } });
        if (response.ok) {
          const status = await response.json();
          if (status.banned) {
            document.getElementById('banAlert').style.display = 'flex';
            document.getElementById('banReason').textContent = `åŸå› : ${status.reason || 'æ»¥ç”¨å…±äº«èµ„æº'}`;
            const remainingHours = Math.ceil(status.remainingTime / 3600000);
            document.getElementById('banTime').textContent = `è§£ç¦æ—¶é—´: ${new Date(status.banUntil).toLocaleString()} (çº¦ ${remainingHours} å°æ—¶å)`;
          }
        }
      } catch (error) { console.error('åŠ è½½å°ç¦çŠ¶æ€å¤±è´¥:', error); }
    }

    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/admin/shared/stats`);
        const data = await response.json();
        document.getElementById('totalShared').textContent = data.totalShared || 0;
        document.getElementById('totalAvailable').textContent = data.totalAvailable || 0;
        document.getElementById('totalLimit').textContent = data.totalLimitToday || 0;
        document.getElementById('totalUsed').textContent = data.totalUsageToday || 0;
      } catch (error) { console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error); }
    }

    async function loadTokens() {
      try {
        const response = await fetch(`${API_BASE}/admin/shared/tokens`);
        const tokens = await response.json();
        const container = document.getElementById('tokenList');
        if (tokens.length === 0) {
          container.innerHTML = `<div class="empty-state"><h3>æš‚æ— å…±äº« Token</h3><p>è¿˜æ²¡æœ‰ç”¨æˆ·å…±äº« Token</p></div>`;
          return;
        }
        container.innerHTML = tokens.map(token => {
          const usagePercent = (token.usageToday / token.dailyLimit * 100).toFixed(1);
          const remaining = token.remainingToday;
          let statusClass = 'status-available', statusText = 'å¯ç”¨';
          if (remaining === 0) { statusClass = 'status-full'; statusText = 'å·²æ»¡'; }
          else if (usagePercent > 80) { statusClass = 'status-limited'; statusText = 'å³å°†æ»¡é¢'; }
          return `
            <div class="token-item">
              <div class="token-header">
                <div>
                  <div class="token-owner">è´¡çŒ®è€…: ${token.username}</div>
                  ${token.email ? `<div class="token-email">${token.email}</div>` : ''}
                </div>
                <span class="status-badge ${statusClass}">${statusText}</span>
              </div>
              <div class="progress-container">
                <div class="progress-label"><span>ä»Šæ—¥ä½¿ç”¨</span><span><strong>${token.usageToday}</strong> / ${token.dailyLimit}</span></div>
                <div class="progress-bar-bg"><div class="progress-bar" style="width: ${Math.min(usagePercent, 100)}%"></div></div>
              </div>
            </div>`;
        }).join('');
      } catch (error) {
        console.error('åŠ è½½ Token åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('tokenList').innerHTML = `<div class="empty-state"><h3>åŠ è½½å¤±è´¥</h3></div>`;
      }
    }

    async function loadActiveVotes() {
      try {
        const response = await fetch(`${API_BASE}/admin/shared/votes`);
        const votes = await response.json();
        document.getElementById('activeVotesCount').textContent = votes.length;
        const container = document.getElementById('activeVoteList');
        if (votes.length === 0) {
          container.innerHTML = `<div class="empty-state"><h3>æš‚æ— æ´»è·ƒæŠ•ç¥¨</h3></div>`;
          return;
        }
        container.innerHTML = votes.map(vote => renderVoteCard(vote, true)).join('');
      } catch (error) { console.error('åŠ è½½æŠ•ç¥¨å¤±è´¥:', error); }
    }

    async function loadVoteHistory() {
      try {
        const response = await fetch(`${API_BASE}/admin/shared/votes/all`);
        const votes = await response.json();
        const container = document.getElementById('voteHistory');
        const historyVotes = votes.filter(v => v.status !== 'active');
        if (historyVotes.length === 0) {
          container.innerHTML = `<div class="empty-state"><h3>æš‚æ— æŠ•ç¥¨è®°å½•</h3></div>`;
          return;
        }
        container.innerHTML = historyVotes.map(vote => renderVoteCard(vote, false)).join('');
      } catch (error) { console.error('åŠ è½½æŠ•ç¥¨å†å²å¤±è´¥:', error); }
    }

    function renderVoteCard(vote, isActive) {
      const banVotes = Object.values(vote.votes).filter(v => v === 'ban').length;
      const unbanVotes = Object.values(vote.votes).filter(v => v === 'unban').length;
      const totalVotes = Object.keys(vote.votes).length;
      let statusBadge = '';
      if (vote.status === 'passed') statusBadge = '<span style="background:#fee2e2;color:#991b1b;padding:4px 10px;border-radius:6px;font-size:0.8em;">å·²é€šè¿‡</span>';
      else if (vote.status === 'rejected') statusBadge = '<span style="background:#d1fae5;color:#065f46;padding:4px 10px;border-radius:6px;font-size:0.8em;">å·²å¦å†³</span>';
      else if (vote.status === 'expired') statusBadge = '<span style="background:#e2e8f0;color:#64748b;padding:4px 10px;border-radius:6px;font-size:0.8em;">å·²è¿‡æœŸ</span>';
      const remainingHours = Math.max(0, Math.ceil((vote.expiresAt - Date.now()) / 3600000));
      return `
        <div class="vote-item">
          <div class="vote-header">
            <div><div class="vote-target">ä¸¾æŠ¥ç”¨æˆ·: ${vote.targetUserId}</div><div class="vote-reason">${vote.reason}</div></div>
            <div>${statusBadge} ${isActive ? `<span class="countdown">å‰©ä½™ ${remainingHours} å°æ—¶</span>` : ''}</div>
          </div>
          <div class="vote-meta">å‘èµ·äºº: ${vote.createdBy} Â· ${new Date(vote.createdAt).toLocaleString()}</div>
          <div class="vote-stats">
            <span style="background:#fee2e2;color:#991b1b;">å°ç¦: ${banVotes}</span>
            <span style="background:#d1fae5;color:#065f46;">åå¯¹: ${unbanVotes}</span>
            <span style="background:#e2e8f0;color:#64748b;">æ€»ç¥¨: ${totalVotes}</span>
          </div>
          ${isActive && userToken ? `<div class="vote-actions"><button class="btn btn-danger" onclick="castVote('${vote.id}', 'ban')">æŠ•ç¥¨å°ç¦</button><button class="btn btn-success" onclick="castVote('${vote.id}', 'unban')">æŠ•ç¥¨åå¯¹</button></div>` : ''}
          <div class="comments-section">
            <strong style="font-size:0.9em;">è®¨è®º (${vote.comments?.length || 0})</strong>
            ${(vote.comments || []).slice(-5).map(c => `<div class="comment-item"><span class="comment-author">${c.userId}</span><span class="comment-time">${new Date(c.time).toLocaleString()}</span><div style="margin-top:4px;">${c.content}</div></div>`).join('')}
            ${isActive && userToken ? `<div class="comment-input"><input type="text" id="comment_${vote.id}" placeholder="å‘è¡¨è¯„è®º..."><button class="btn btn-primary" onclick="addComment('${vote.id}')">å‘é€</button></div>` : ''}
          </div>
        </div>`;
    }

    async function castVote(voteId, decision) {
      if (!userToken) { alert('è¯·å…ˆç™»å½•ç”¨æˆ·ä¸­å¿ƒ'); return; }
      try {
        const response = await fetch(`${API_BASE}/admin/shared/votes/${voteId}/cast`, {
          method: 'POST', headers: { 'Content-Type': 'application/json', 'X-User-Token': userToken },
          body: JSON.stringify({ decision })
        });
        const result = await response.json();
        if (result.error) alert(result.error);
        else { alert('æŠ•ç¥¨æˆåŠŸï¼'); loadActiveVotes(); }
      } catch (error) { alert('æŠ•ç¥¨å¤±è´¥: ' + error.message); }
    }

    async function addComment(voteId) {
      if (!userToken) { alert('è¯·å…ˆç™»å½•ç”¨æˆ·ä¸­å¿ƒ'); return; }
      const input = document.getElementById(`comment_${voteId}`);
      const content = input.value.trim();
      if (!content) return;
      try {
        const response = await fetch(`${API_BASE}/admin/shared/votes/${voteId}/comment`, {
          method: 'POST', headers: { 'Content-Type': 'application/json', 'X-User-Token': userToken },
          body: JSON.stringify({ content })
        });
        const result = await response.json();
        if (result.error) alert(result.error);
        else { input.value = ''; loadActiveVotes(); }
      } catch (error) { alert('è¯„è®ºå¤±è´¥: ' + error.message); }
    }

    function showCreateVoteModal() {
      if (!userToken) { alert('è¯·å…ˆç™»å½•ç”¨æˆ·ä¸­å¿ƒæ‰èƒ½å‘èµ·æŠ•ç¥¨'); return; }
      document.getElementById('voteModal').style.display = 'flex';
    }
    function hideCreateVoteModal() { document.getElementById('voteModal').style.display = 'none'; }

    async function submitVote() {
      const targetUserId = document.getElementById('voteTargetUser').value.trim();
      const reason = document.getElementById('voteReason').value.trim();
      if (!targetUserId || !reason) { alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'); return; }
      try {
        const response = await fetch(`${API_BASE}/admin/shared/votes`, {
          method: 'POST', headers: { 'Content-Type': 'application/json', 'X-User-Token': userToken },
          body: JSON.stringify({ targetUserId, reason })
        });
        const result = await response.json();
        if (result.error) alert(result.error);
        else {
          alert('æŠ•ç¥¨å·²åˆ›å»ºï¼å°†åœ¨24å°æ—¶åç»Ÿè®¡ç»“æœã€‚');
          hideCreateVoteModal();
          document.getElementById('voteTargetUser').value = '';
          document.getElementById('voteReason').value = '';
          loadActiveVotes();
        }
      } catch (error) { alert('åˆ›å»ºæŠ•ç¥¨å¤±è´¥: ' + error.message); }
    }

    // åŠ è½½ç”¨æˆ·ä½¿ç”¨ç»Ÿè®¡
    async function loadUserUsage() {
      try {
        const response = await fetch(`${API_BASE}/admin/shared/user-usage`);
        if (!response.ok) {
          throw new Error('è·å–ç”¨æˆ·ç»Ÿè®¡å¤±è´¥');
        }
        const users = await response.json();
        const container = document.getElementById('userUsageList');

        if (!users || users.length === 0) {
          container.innerHTML = `<div class="empty-state"><h3>æš‚æ— ä½¿ç”¨è®°å½•</h3><p>è¿˜æ²¡æœ‰ç”¨æˆ·ä½¿ç”¨å…±äº«Token</p></div>`;
          return;
        }

        // æŒ‰å¹³å‡ä½¿ç”¨é‡æ’åº
        users.sort((a, b) => b.avgUsage - a.avgUsage);

        container.innerHTML = users.map((user, index) => {
          const avgUsage = user.avgUsage || 0;
          const todayUsage = user.todayUsage || 0;
          const totalDays = user.totalDays || 0;
          const totalUsage = user.totalUsage || 0;
          const maxUsage = user.maxUsage || 0;

          // è®¡ç®—ä½¿ç”¨ç­‰çº§
          let levelClass = 'status-available';
          let levelText = 'æ­£å¸¸';
          if (avgUsage > 50) {
            levelClass = 'status-full';
            levelText = 'å¼‚å¸¸';
          } else if (avgUsage > 30) {
            levelClass = 'status-limited';
            levelText = 'åé«˜';
          }

          // æ˜¯å¦è¢«å°ç¦
          const isBanned = user.banned || false;
          const banInfo = isBanned ? `<span style="color: #ef4444; font-weight: 600; margin-left: 8px;">ğŸš« å·²å°ç¦</span>` : '';

          return `
            <div class="token-item" style="${isBanned ? 'opacity: 0.7; border-color: #ef4444;' : ''}">
              <div class="token-header">
                <div>
                  <div class="token-owner" style="display: flex; align-items: center; gap: 8px;">
                    <span style="color: var(--gray); font-size: 0.9em;">#${index + 1}</span>
                    ${user.username || 'æœªçŸ¥ç”¨æˆ·'}
                    ${banInfo}
                  </div>
                  ${user.email ? `<div class="token-email">${user.email}</div>` : ''}
                </div>
                <span class="status-badge ${levelClass}">${levelText}</span>
              </div>

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-top: 14px; padding: 12px; background: white; border-radius: 8px;">
                <div style="text-align: center;">
                  <div style="color: var(--gray); font-size: 0.8em;">å¹³å‡æ—¥ä½¿ç”¨</div>
                  <div style="font-size: 1.3em; font-weight: 700; color: ${avgUsage > 50 ? '#ef4444' : avgUsage > 30 ? '#f59e0b' : '#10b981'};">${avgUsage}</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: var(--gray); font-size: 0.8em;">ä»Šæ—¥ä½¿ç”¨</div>
                  <div style="font-size: 1.3em; font-weight: 700; color: var(--primary);">${todayUsage}</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: var(--gray); font-size: 0.8em;">æœ€å¤§æ—¥ä½¿ç”¨</div>
                  <div style="font-size: 1.3em; font-weight: 700; color: var(--secondary);">${maxUsage}</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: var(--gray); font-size: 0.8em;">ä½¿ç”¨å¤©æ•°</div>
                  <div style="font-size: 1.3em; font-weight: 700; color: var(--info);">${totalDays}</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: var(--gray); font-size: 0.8em;">æ€»ä½¿ç”¨æ¬¡æ•°</div>
                  <div style="font-size: 1.3em; font-weight: 700; color: var(--gray);">${totalUsage}</div>
                </div>
              </div>

              ${isBanned && user.banReason ? `
                <div style="margin-top: 10px; padding: 8px 12px; background: #fee2e2; border-radius: 6px; color: #991b1b; font-size: 0.85em;">
                  <strong>å°ç¦åŸå› :</strong> ${user.banReason}
                  ${user.banUntil ? `<br><strong>è§£å°æ—¶é—´:</strong> ${new Date(user.banUntil).toLocaleString()}` : ''}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·ç»Ÿè®¡å¤±è´¥:', error);
        document.getElementById('userUsageList').innerHTML = `
          <div class="empty-state">
            <h3>åŠ è½½å¤±è´¥</h3>
            <p style="color: #ef4444;">${error.message}</p>
          </div>
        `;
      }
    }

    async function init() {
      await loadBanStatus();
      await loadStats();
      await loadTokens();
      await loadActiveVotes();
      setInterval(async () => { await loadStats(); await loadTokens(); }, 30000);
    }
    init();
  </script>
</body>
</html>
