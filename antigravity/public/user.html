<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Antigravity API - ç”¨æˆ·ä¸­å¿ƒ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --dark: #1e293b;
      --light: #f8fafc;
      --gray: #64748b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f0f4ff 0%, #faf5ff 50%, #fef3f2 100%);
      min-height: 100vh;
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* ç™»å½•/æ³¨å†Œé¡µé¢ */
    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .auth-overlay.hidden {
      display: none;
    }

    .auth-box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 48px 40px;
      border-radius: 24px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.35);
      width: 100%;
      max-width: 420px;
      text-align: center;
    }

    .auth-box h2 {
      color: var(--dark);
      margin-bottom: 8px;
      font-size: 2em;
      font-weight: 700;
    }

    .auth-box p {
      color: var(--gray);
      margin-bottom: 32px;
    }

    .auth-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--gray);
      transition: all 0.2s;
    }

    .auth-tab.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-color: transparent;
      color: white;
    }

    .auth-form {
      display: none;
      text-align: left;
    }

    .auth-form.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.95em;
    }

    input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 0.95em;
      transition: all 0.2s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    button {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .auth-error {
      color: var(--danger);
      margin-top: 16px;
      font-size: 0.9em;
      font-weight: 500;
    }

    .auth-link {
      margin-top: 20px;
      font-size: 0.9em;
      color: var(--gray);
    }

    .auth-link a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }

    /* ç”¨æˆ·é¢æ¿ */
    .header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
      padding: 32px 40px;
      border-radius: 24px;
      box-shadow: var(--shadow-lg);
      margin-bottom: 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      color: white;
      font-size: 1.8em;
      font-weight: 700;
    }

    .header-info {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.95em;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn-logout {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      padding: 10px 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* å¯¼èˆªæ  */
    .nav-bar {
      background: white;
      padding: 12px 20px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .nav-btn {
      padding: 10px 20px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--gray);
      transition: all 0.2s;
      width: auto;
    }

    .nav-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: none;
      box-shadow: none;
    }

    .nav-btn.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-color: transparent;
      color: white;
    }

    .nav-btn.active:hover {
      color: white;
    }

    /* é¡µé¢å†…å®¹åŒºåŸŸ */
    .page-content {
      display: none;
    }

    .page-content.active {
      display: block;
    }

    .card {
      background: white;
      padding: 28px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
    }

    .card h3 {
      color: var(--dark);
      margin-bottom: 20px;
      font-size: 1.25em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .key-item {
      background: #f8f9fa;
      padding: 20px;
      margin-bottom: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .key-item:hover {
      border-color: var(--primary);
    }

    .key-value {
      font-family: 'Courier New', monospace;
      background: white;
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid var(--border);
      margin: 10px 0;
      word-break: break-all;
      font-size: 0.9em;
    }

    .key-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }

    .key-meta small {
      color: var(--gray);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      padding: 8px 16px;
      font-size: 0.9em;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .copy-btn {
      background: var(--primary);
      padding: 6px 12px;
      font-size: 0.8em;
      border-radius: 6px;
    }

    .copy-btn.copied {
      background: var(--success);
    }

    .alert {
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .stat-card h4 {
      color: var(--gray);
      font-size: 0.85em;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }

    .empty-state p {
      margin-bottom: 20px;
    }

    .flex-buttons {
      display: flex;
      gap: 10px;
    }

    .code-block {
      background: #1e293b;
      color: #e2e8f0;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      overflow-x: auto;
      margin: 12px 0;
    }

    .admin-link {
      text-align: center;
      margin-top: 20px;
      font-size: 0.85em;
    }

    .admin-link a {
      color: var(--gray);
      text-decoration: none;
    }

    .admin-link a:hover {
      color: var(--primary);
    }

    /* æ³¨å†Œæ¡æ¬¾å¼¹çª— */
    .terms-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      padding: 20px;
    }

    .terms-modal.hidden {
      display: none;
    }

    .terms-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .terms-content h2 {
      color: var(--dark);
      margin-bottom: 20px;
      font-size: 1.8em;
      text-align: center;
    }

    .terms-content h3 {
      color: var(--primary);
      margin-top: 24px;
      margin-bottom: 12px;
      font-size: 1.2em;
    }

    .terms-content p, .terms-content ul {
      color: var(--dark);
      line-height: 1.8;
      margin-bottom: 16px;
    }

    .terms-content ul {
      padding-left: 24px;
    }

    .terms-content li {
      margin-bottom: 8px;
    }

    .terms-highlight {
      background: linear-gradient(135deg, #fef3c7 0%, #fef9e6 100%);
      padding: 16px 20px;
      border-radius: 10px;
      border-left: 4px solid var(--warning);
      margin: 20px 0;
      font-weight: 600;
      color: #92400e;
    }

    .terms-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      justify-content: center;
    }

    .btn-accept {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: white;
      padding: 12px 32px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-accept:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-decline {
      background: #f1f5f9;
      color: var(--dark);
      padding: 12px 32px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-decline:hover {
      background: #e2e8f0;
    }

    .terms-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .terms-checkbox input {
      width: auto;
      cursor: pointer;
    }

    .terms-checkbox label {
      margin: 0;
      cursor: pointer;
      font-size: 0.95em;
    }

    .terms-link {
      color: var(--primary);
      text-decoration: underline;
      cursor: pointer;
    }

    .terms-link:hover {
      color: var(--primary-dark);
    }

    /* å…¬å‘Šæ ·å¼ */
    .announcement-container {
      margin-bottom: 24px;
    }

    .announcement {
      background: white;
      padding: 20px 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      border-left: 4px solid var(--primary);
      transition: all 0.2s;
    }

    .announcement:hover {
      box-shadow: var(--shadow-lg);
    }

    .announcement.pinned {
      border-left-color: var(--warning);
      background: linear-gradient(135deg, #fef3c7 0%, #fef9e6 100%);
    }

    .announcement.type-success {
      border-left-color: var(--success);
      background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
    }

    .announcement.type-danger {
      border-left-color: var(--danger);
      background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
    }

    .announcement.type-info {
      border-left-color: var(--info);
      background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
    }

    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .announcement-title {
      font-size: 1.1em;
      font-weight: 700;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .announcement-badge {
      font-size: 0.75em;
      padding: 4px 8px;
      border-radius: 6px;
      background: var(--warning);
      color: white;
      font-weight: 600;
    }

    .announcement-time {
      font-size: 0.85em;
      color: var(--gray);
    }

    .announcement-content {
      color: var(--dark);
      line-height: 1.7;
      margin-bottom: 12px;
    }

    .announcement-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .announcement-image {
      width: 100%;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .announcement-image:hover {
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
        gap: 16px;
      }

      .auth-box {
        margin: 16px;
        padding: 32px 24px;
      }
    }
  </style>
</head>
<body>
  <!-- æ³¨å†Œæ¡æ¬¾å¼¹çª— -->
  <div id="termsModal" class="terms-modal hidden">
    <div class="terms-content">
      <h2>ğŸ“‹ ç”¨æˆ·æ³¨å†Œåè®®ä¸ä½¿ç”¨é¡»çŸ¥</h2>

      <div class="terms-highlight">
        âš ï¸ é‡è¦å£°æ˜ï¼šæœ¬æœåŠ¡ä»…ä¾›å­¦ä¹ ã€ç ”ç©¶å’ŒæŠ€æœ¯äº¤æµä½¿ç”¨ï¼Œè¯·å‹¿ç”¨äºä»»ä½•å•†ä¸šæˆ–éæ³•ç”¨é€”ï¼
      </div>

      <h3>ä¸€ã€æœåŠ¡æ€§è´¨</h3>
      <p>Antigravity API æ˜¯ä¸€ä¸ªå­¦ä¹ å‹ API ä»£ç†æœåŠ¡å¹³å°ï¼Œæ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›å­¦ä¹ å’Œæµ‹è¯•ç¯å¢ƒã€‚ä½¿ç”¨æœ¬æœåŠ¡å³è¡¨ç¤ºæ‚¨åŒæ„ä»¥ä¸‹æ¡æ¬¾ï¼š</p>
      <ul>
        <li>æœ¬æœåŠ¡<strong>ä»…ä¾›å­¦ä¹ ã€ç ”ç©¶å’ŒæŠ€æœ¯äº¤æµ</strong>ä½¿ç”¨</li>
        <li>ç¦æ­¢å°†æœ¬æœåŠ¡ç”¨äºä»»ä½•å•†ä¸šç”¨é€”æˆ–ç›ˆåˆ©è¡Œä¸º</li>
        <li>ç¦æ­¢åˆ©ç”¨æœ¬æœåŠ¡ä»äº‹ä»»ä½•è¿æ³•è¿è§„æ´»åŠ¨</li>
        <li>æœ¬æœåŠ¡ä¸å¯¹æ•°æ®å®‰å…¨æ€§ã€å¯ç”¨æ€§åšä»»ä½•ä¿è¯</li>
      </ul>

      <h3>äºŒã€è´¦å·å®‰å…¨</h3>
      <ul>
        <li>æ‚¨éœ€è¦å¦¥å–„ä¿ç®¡è´¦å·å¯†ç ï¼Œä¸è¦ä¸ä»–äººåˆ†äº«</li>
        <li>å»ºè®®ä½¿ç”¨å¤æ‚å¯†ç ï¼Œé•¿åº¦è‡³å°‘ 8 ä½ï¼ŒåŒ…å«å­—æ¯ã€æ•°å­—å’Œç¬¦å·</li>
        <li>å®šæœŸæ›´æ¢å¯†ç ï¼Œå‘ç°å¼‚å¸¸ç«‹å³ä¿®æ”¹å¯†ç </li>
        <li>API å¯†é’¥ä¸€æ—¦ç”Ÿæˆï¼Œè¯·ç«‹å³ä¿å­˜ï¼Œç³»ç»Ÿä¸ä¼šå†æ¬¡å®Œæ•´æ˜¾ç¤º</li>
        <li>ä¸è¦åœ¨å…¬å¼€åœºåˆæˆ–ä»£ç ä»“åº“ä¸­æ³„éœ²æ‚¨çš„ API å¯†é’¥</li>
      </ul>

      <h3>ä¸‰ã€ä½¿ç”¨è§„èŒƒ</h3>
      <ul>
        <li>åˆç†ä½¿ç”¨ API æ¥å£ï¼Œé¿å…é«˜é¢‘è¯·æ±‚å½±å“ç³»ç»Ÿç¨³å®šæ€§</li>
        <li>éµå®ˆé¢‘ç‡é™åˆ¶ï¼Œè¶…å‡ºé™åˆ¶å°†è¢«æš‚æ—¶å°ç¦</li>
        <li>æ¯ä¸ªç”¨æˆ·æœ€å¤šå¯åˆ›å»º 5 ä¸ª API å¯†é’¥</li>
        <li>ä¸å¾—åˆ©ç”¨æœ¬æœåŠ¡è¿›è¡Œæ”»å‡»ã€çˆ¬è™«ã€åˆ·é‡ç­‰æ¶æ„è¡Œä¸º</li>
        <li>ä¸å¾—ç»•è¿‡ç³»ç»Ÿå®‰å…¨æœºåˆ¶æˆ–å°è¯•å…¥ä¾µç³»ç»Ÿ</li>
      </ul>

      <h3>å››ã€Token å…±äº«è§„åˆ™</h3>
      <ul>
        <li>ç”¨æˆ·å¯è‡ªæ„¿åˆ†äº«è‡ªå·±çš„ Google Token ä¾›ä»–äººä½¿ç”¨</li>
        <li>å…±äº« Token éœ€è®¾ç½®åˆç†çš„æ¯æ—¥ä½¿ç”¨é™é¢</li>
        <li>æ‚¨å¯¹è‡ªå·±å…±äº«çš„ Token äº§ç”Ÿçš„æ‰€æœ‰è¡Œä¸ºè´Ÿè´£</li>
        <li>å¦‚å‘ç°æ»¥ç”¨ï¼Œç®¡ç†å‘˜æœ‰æƒç¦ç”¨æ‚¨çš„å…±äº«åŠŸèƒ½</li>
        <li>è¯·å‹¿å…±äº«æ¥æºä¸æ˜æˆ–éæ³•è·å–çš„ Token</li>
      </ul>

      <h3>äº”ã€éšç§ä¿æŠ¤</h3>
      <ul>
        <li>æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§ï¼Œä»…æ”¶é›†å¿…è¦çš„è´¦å·ä¿¡æ¯</li>
        <li>æ‚¨çš„é‚®ç®±ã€å¯†ç ç­‰ä¿¡æ¯å°†è¢«åŠ å¯†å­˜å‚¨</li>
        <li>æˆ‘ä»¬ä¸ä¼šå‘ç¬¬ä¸‰æ–¹å‡ºå”®æˆ–æ³„éœ²æ‚¨çš„ä¸ªäººä¿¡æ¯</li>
        <li>ç³»ç»Ÿä¼šè®°å½•å¿…è¦çš„æ“ä½œæ—¥å¿—ç”¨äºå®‰å…¨å®¡è®¡</li>
      </ul>

      <h3>å…­ã€å…è´£å£°æ˜</h3>
      <ul>
        <li>æœ¬æœåŠ¡æŒ‰"ç°çŠ¶"æä¾›ï¼Œä¸æä¾›ä»»ä½•æ˜ç¤ºæˆ–æš—ç¤ºçš„ä¿è¯</li>
        <li>æœåŠ¡å¯èƒ½éšæ—¶ä¸­æ–­ã€åœæ­¢æˆ–ä¿®æ”¹ï¼Œæ•ä¸å¦è¡Œé€šçŸ¥</li>
        <li>å› ä½¿ç”¨æœ¬æœåŠ¡äº§ç”Ÿçš„ä»»ä½•æŸå¤±ï¼Œæˆ‘ä»¬ä¸æ‰¿æ‹…è´£ä»»</li>
        <li>ç”¨æˆ·åº”è‡ªè¡Œæ‰¿æ‹…ä½¿ç”¨æœ¬æœåŠ¡çš„æ‰€æœ‰é£é™©</li>
        <li>å¯¹äºç”¨æˆ·ä¸Šä¼ æˆ–ç”Ÿæˆçš„å†…å®¹ï¼Œæˆ‘ä»¬ä¸æ‰¿æ‹…å®¡æŸ¥ä¹‰åŠ¡</li>
      </ul>

      <h3>ä¸ƒã€è¿è§„å¤„ç†</h3>
      <p>å¦‚æœå‘ç°æ‚¨æœ‰ä»¥ä¸‹è¡Œä¸ºï¼Œæˆ‘ä»¬å°†é‡‡å–ç›¸åº”æªæ–½ï¼š</p>
      <ul>
        <li><strong>è½»åº¦è¿è§„</strong>ï¼šå‘å‡ºè­¦å‘Šã€é™åˆ¶åŠŸèƒ½ä½¿ç”¨</li>
        <li><strong>ä¸­åº¦è¿è§„</strong>ï¼šæš‚æ—¶å°ç¦è´¦å·ã€åˆ é™¤è¿è§„å†…å®¹</li>
        <li><strong>ä¸¥é‡è¿è§„</strong>ï¼šæ°¸ä¹…å°ç¦è´¦å·åŠå…³è” IP/è®¾å¤‡</li>
        <li><strong>è¿æ³•è¡Œä¸º</strong>ï¼šä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©</li>
      </ul>

      <h3>å…«ã€å…¶ä»–æ¡æ¬¾</h3>
      <ul>
        <li>æœ¬åè®®çš„è§£é‡Šæƒå½’å¹³å°æ‰€æœ‰</li>
        <li>æˆ‘ä»¬ä¿ç•™éšæ—¶ä¿®æ”¹æœ¬åè®®çš„æƒåˆ©</li>
        <li>ç»§ç»­ä½¿ç”¨æœåŠ¡å³è§†ä¸ºæ¥å—ä¿®æ”¹åçš„åè®®</li>
        <li>å¦‚æœ‰ç–‘é—®ï¼Œè¯·é€šè¿‡ç®¡ç†å‘˜å…¥å£è”ç³»æˆ‘ä»¬</li>
      </ul>

      <div class="terms-highlight" style="margin-top: 30px;">
        ğŸ“– è¯·ä»”ç»†é˜…è¯»ä»¥ä¸Šæ¡æ¬¾ã€‚ç‚¹å‡»"åŒæ„å¹¶ç»§ç»­"å³è¡¨ç¤ºæ‚¨å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„éµå®ˆæœ¬åè®®çš„å…¨éƒ¨å†…å®¹ã€‚
      </div>

      <div class="terms-actions">
        <button class="btn-decline" onclick="closeTermsModal()">å–æ¶ˆæ³¨å†Œ</button>
        <button class="btn-accept" onclick="acceptTerms()">åŒæ„å¹¶ç»§ç»­</button>
      </div>
    </div>
  </div>

  <!-- ç™»å½•/æ³¨å†Œé¡µé¢ -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-box">
      <h2>ç”¨æˆ·ä¸­å¿ƒ</h2>
      <p>ç™»å½•æˆ–æ³¨å†Œä»¥ç®¡ç†æ‚¨çš„ API å¯†é’¥</p>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login', event)">ç™»å½•</button>
        <button class="auth-tab" onclick="switchAuthTab('register', event)">æ³¨å†Œ</button>
      </div>

      <!-- ç™»å½•è¡¨å• -->
      <div id="loginForm" class="auth-form active">
        <div class="form-group">
          <label>ç”¨æˆ·å</label>
          <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" onkeypress="if(event.key==='Enter')doUserLogin()">
        </div>
        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " onkeypress="if(event.key==='Enter')doUserLogin()">
        </div>
        <button onclick="doUserLogin()" id="loginBtn">ç™»å½•</button>
      </div>

      <!-- æ³¨å†Œè¡¨å• -->
      <div id="registerForm" class="auth-form">
        <div class="form-group">
          <label>ç”¨æˆ·å <span style="color: var(--danger);">*</span></label>
          <input type="text" id="regUsername" placeholder="3-20ä¸ªå­—ç¬¦ï¼Œå­—æ¯æ•°å­—ä¸‹åˆ’çº¿">
        </div>
        <div class="form-group">
          <label>é‚®ç®±</label>
          <input type="email" id="regEmail" placeholder="å¯é€‰">
        </div>
        <div class="form-group">
          <label>å¯†ç  <span style="color: var(--danger);">*</span></label>
          <input type="password" id="regPassword" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦">
        </div>
        <div class="form-group">
          <label>ç¡®è®¤å¯†ç  <span style="color: var(--danger);">*</span></label>
          <input type="password" id="regConfirmPassword" placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
        </div>
        <div class="form-group">
          <label>éªŒè¯ç  <span style="color: var(--danger);">*</span></label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <div id="captchaDisplay" style="background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%); padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 1.1em; color: var(--primary); letter-spacing: 2px; user-select: none; min-width: 120px; text-align: center;"></div>
            <button type="button" onclick="refreshCaptcha()" style="padding: 10px 16px; font-size: 0.85em; width: auto;">åˆ·æ–°</button>
          </div>
          <input type="text" id="regCaptcha" placeholder="è¯·è¾“å…¥éªŒè¯ç ç»“æœ" style="margin-top: 10px;" onkeypress="if(event.key==='Enter')doUserRegister()">
        </div>
        <div class="terms-checkbox">
          <input type="checkbox" id="agreeTerms">
          <label for="agreeTerms">æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <span class="terms-link" onclick="showTermsModal()">ã€Šç”¨æˆ·æ³¨å†Œåè®®ä¸ä½¿ç”¨é¡»çŸ¥ã€‹</span></label>
        </div>
        <button onclick="doUserRegister()" id="registerBtn">æ³¨å†Œ</button>
      </div>

      <div id="authError" class="auth-error"></div>

      <div class="admin-link">
        <a href="/">ç®¡ç†å‘˜å…¥å£</a>
      </div>
    </div>
  </div>

  <!-- ç”¨æˆ·é¢æ¿ -->
  <div class="container">
    <div class="header">
      <div>
        <h1>ç”¨æˆ·ä¸­å¿ƒ</h1>
        <div class="header-info">æ¬¢è¿å›æ¥ï¼Œ<span id="displayUsername">ç”¨æˆ·</span></div>
      </div>
      <div class="header-actions">
        <button onclick="doUserLogout()" class="btn-logout">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <div class="nav-bar">
      <button class="nav-btn active" onclick="switchPage('home')">é¦–é¡µ</button>
      <button class="nav-btn" onclick="switchPage('keys')">å¯†é’¥ç®¡ç†</button>
      <button class="nav-btn" onclick="switchPage('tokens')">Token ç®¡ç†</button>
      <button class="nav-btn" onclick="window.open('/share.html', '_blank')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-color: transparent;">ğŸŒ å…±äº«ä¸­å¿ƒ</button>
      <button class="nav-btn" onclick="switchPage('docs')">API æ–‡æ¡£</button>
      <button class="nav-btn" onclick="switchPage('test')">æµ‹è¯•</button>
      <button class="nav-btn" onclick="switchPage('settings')">è®¾ç½®</button>
    </div>

    <!-- é¦–é¡µ -->
    <div id="page-home" class="page-content active">
      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="stats-grid">
        <div class="stat-card">
          <h4>API å¯†é’¥æ•°</h4>
          <div class="stat-value" id="keyCount">0</div>
        </div>
        <div class="stat-card">
          <h4>æ€»è¯·æ±‚æ•°</h4>
          <div class="stat-value" id="totalRequests">0</div>
        </div>
      </div>

      <!-- ç³»ç»Ÿå…¬å‘Š -->
      <div id="announcementContainer" class="announcement-container"></div>

      <!-- ç”Ÿæˆå¯†é’¥ -->
      <div class="card">
        <h3>ç”Ÿæˆ API å¯†é’¥</h3>
        <p style="color: var(--gray); margin-bottom: 16px;">
          API å¯†é’¥ç”¨äºæ‚¨çš„åº”ç”¨è°ƒç”¨æœ¬æœåŠ¡çš„æ¥å£ã€‚ä¸"Token ç®¡ç†"ä¸­çš„ Google Token ä¸åŒï¼Œåè€…æ˜¯ç»™æœ¬æœåŠ¡è°ƒç”¨ Google API ä½¿ç”¨çš„ã€‚
        </p>
        <div class="form-group">
          <label>å¯†é’¥åç§°ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="keyName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„åº”ç”¨">
        </div>
        <button onclick="generateKey()" class="btn-success" style="width: auto;">ç”Ÿæˆå¯†é’¥</button>
        <div id="generateResult" style="margin-top: 15px;"></div>
      </div>

      <!-- æˆ‘çš„å¯†é’¥ -->
      <div class="card">
        <h3>æˆ‘çš„ API å¯†é’¥</h3>
        <div id="keyList">
          <div class="empty-state">
            <p>æš‚æ— å¯†é’¥</p>
            <p>ç‚¹å‡»ä¸Šæ–¹"ç”Ÿæˆå¯†é’¥"åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ª API å¯†é’¥</p>
          </div>
        </div>
      </div>
    </div>

    <!-- å¯†é’¥ç®¡ç†é¡µé¢ -->
    <div id="page-keys" class="page-content">
      <div class="alert alert-info">
        <strong>è¯´æ˜ï¼š</strong>API å¯†é’¥ï¼ˆsk-user- å¼€å¤´ï¼‰æ˜¯æ‚¨ç”¨æ¥è°ƒç”¨æœ¬æœåŠ¡ API çš„å‡­è¯ã€‚è¿™ä¸"Token ç®¡ç†"ä¸­çš„ Google Tokenï¼ˆç”¨äºæœ¬æœåŠ¡åç«¯è°ƒç”¨ Google APIï¼‰æ˜¯å®Œå…¨ä¸åŒçš„ä¸¤ä¸ªæ¦‚å¿µã€‚
      </div>

      <div class="card">
        <h3>ç”Ÿæˆæ–°å¯†é’¥</h3>
        <div class="form-group">
          <label>å¯†é’¥åç§°ï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="keyName2" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„åº”ç”¨">
        </div>
        <button onclick="generateKey2()" class="btn-success" style="width: auto;">ç”Ÿæˆå¯†é’¥</button>
        <div id="generateResult2" style="margin-top: 15px;"></div>
      </div>

      <div class="card">
        <h3>æ‰€æœ‰å¯†é’¥</h3>
        <div id="keyList2">
          <div class="empty-state">
            <p>æš‚æ— å¯†é’¥</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Token ç®¡ç†é¡µé¢ -->
    <div id="page-tokens" class="page-content">
      <!-- Token ç»Ÿè®¡å¡ç‰‡ -->
      <div class="stats-grid">
        <div class="stat-card">
          <h4>æˆ‘çš„ Token æ•°</h4>
          <div class="stat-value" id="tokenCount">0</div>
        </div>
        <div class="stat-card">
          <h4>å·²å…±äº« Token</h4>
          <div class="stat-value" id="sharedTokenCount">0</div>
        </div>
        <div class="stat-card">
          <h4>ä»Šæ—¥å…±äº«ä½¿ç”¨</h4>
          <div class="stat-value" id="sharedUsageToday">0</div>
        </div>
      </div>

      <div class="card">
        <h3>æ·»åŠ  Google Token</h3>
        <p style="color: var(--gray); margin-bottom: 20px;">
          Google Token ç”¨äºæœ¬æœåŠ¡è°ƒç”¨ Google APIï¼Œä¸ä¸Šæ–¹çš„ API å¯†é’¥ï¼ˆç”¨æˆ·è°ƒç”¨æœ¬æœåŠ¡ï¼‰æ˜¯ä¸¤å›äº‹
        </p>

        <button onclick="addGoogleToken()" class="btn-success" style="width: auto; display: flex; align-items: center; gap: 10px; margin: 0;">
          <svg width="18" height="18" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          ä½¿ç”¨ Google è´¦å·æˆæƒ
        </button>

        <div class="alert alert-info" style="margin-top: 20px;">
          <strong>è¯´æ˜ï¼š</strong>æ·»åŠ çš„ Token é»˜è®¤ä»…ä¾›æ‚¨è‡ªå·±ä½¿ç”¨ã€‚æ‚¨å¯ä»¥åœ¨ä¸‹æ–¹çš„ Token åˆ—è¡¨ä¸­å¯ç”¨å…±äº«åŠŸèƒ½ï¼Œè®©å…¶ä»–ç”¨æˆ·ä¹Ÿèƒ½ä½¿ç”¨æ‚¨çš„ Tokenï¼ˆæ¯æ—¥ä½¿ç”¨æ¬¡æ•°å¯è‡ªå®šä¹‰ï¼‰ã€‚æŸ¥çœ‹ <a href="/share.html" target="_blank" style="color: var(--primary); font-weight: 600;">å…±äº«ä¸­å¿ƒ</a> äº†è§£æ›´å¤šã€‚
        </div>
      </div>

      <div class="card">
        <h3>æ‰‹åŠ¨æ·»åŠ  Tokenï¼ˆå›è°ƒé“¾æ¥ï¼‰</h3>
        <p style="color: var(--gray); margin-bottom: 16px;">
          å¦‚æœè‡ªåŠ¨å›è°ƒå¤±è´¥ï¼Œå¯ä»¥å°†æµè§ˆå™¨è·³è½¬åçš„å®Œæ•´å›è°ƒé“¾æ¥ç²˜è´´åˆ°æ­¤å¤„æ·»åŠ  Token
        </p>

        <div class="form-group">
          <label>å›è°ƒé“¾æ¥</label>
          <input type="text" id="callbackUrl" placeholder="http://localhost:xxxx/oauth-callback?code=...">
        </div>

        <button onclick="addTokenFromCallback()" class="btn-secondary" style="width: auto;">æ·»åŠ  Token</button>
        <div id="callbackResult" style="margin-top: 15px;"></div>
      </div>

      <div class="card">
        <h3>æˆ‘çš„ Token</h3>
        <div id="tokenList">
          <div class="empty-state">
            <p>æš‚æ—  Token</p>
            <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ª Google Token</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>ç›´æ¥æ·»åŠ  Token</h3>
        <p style="color: var(--gray); margin-bottom: 16px;">
          å¦‚æœæ‚¨å·²æœ‰ Access Token å’Œ Refresh Tokenï¼Œå¯ä»¥ç›´æ¥åœ¨æ­¤å¤„æ·»åŠ 
        </p>

        <div class="form-group">
          <label>Access Token <span style="color: var(--danger);">*</span></label>
          <input type="text" id="manualAccessToken" placeholder="è¯·è¾“å…¥ Access Token">
        </div>

        <div class="form-group">
          <label>Refresh Token</label>
          <input type="text" id="manualRefreshToken" placeholder="å¯é€‰">
        </div>

        <div class="form-group">
          <label>è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰</label>
          <input type="number" id="manualExpiresIn" placeholder="é»˜è®¤ 3600" value="3600">
        </div>

        <button onclick="addManualToken()" class="btn-secondary" style="width: auto;">æ·»åŠ  Token</button>
        <div id="manualTokenResult" style="margin-top: 15px;"></div>
      </div>
    </div>

    <!-- API æ–‡æ¡£é¡µé¢ -->
    <div id="page-docs" class="page-content">
      <div class="card">
        <h3>API ä½¿ç”¨è¯´æ˜</h3>
        <p style="color: var(--gray); margin-bottom: 16px;">
          ä½¿ç”¨æ‚¨åœ¨"å¯†é’¥ç®¡ç†"ä¸­ç”Ÿæˆçš„ API å¯†é’¥ï¼ˆsk-user- å¼€å¤´ï¼‰æ¥è°ƒç”¨æœ¬æœåŠ¡çš„æ¥å£ï¼š
        </p>

        <div class="code-block">curl <span id="apiBaseUrl">http://localhost:8045</span>/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "model": "gemini-2.0-flash-exp",
    "messages": [{"role": "user", "content": "ä½ å¥½"}],
    "stream": true
  }'</div>

        <div class="alert alert-info" style="margin-top: 16px;">
          <strong>æ³¨æ„ï¼š</strong>æ¯ä¸ªç”¨æˆ·æœ€å¤šå¯åˆ›å»º 5 ä¸ª API å¯†é’¥
        </div>
      </div>

      <div class="card">
        <h3>å¯ç”¨æ¨¡å‹</h3>
        <div id="modelList">
          <p style="color: var(--gray);">æ­£åœ¨åŠ è½½æ¨¡å‹åˆ—è¡¨...</p>
        </div>
      </div>

      <div class="card">
        <h3>è¯·æ±‚ç¤ºä¾‹</h3>
        <h4 style="margin-bottom: 10px; color: var(--dark);">Python</h4>
        <div class="code-block">import requests

response = requests.post(
    "<span class="apiBaseUrl2">http://localhost:8045</span>/v1/chat/completions",
    headers={
        "Content-Type": "application/json",
        "Authorization": "Bearer YOUR_API_KEY"
    },
    json={
        "model": "gemini-2.0-flash-exp",
        "messages": [{"role": "user", "content": "ä½ å¥½"}],
        "stream": False
    }
)
print(response.json())</div>

        <h4 style="margin: 20px 0 10px; color: var(--dark);">JavaScript</h4>
        <div class="code-block">const response = await fetch('<span class="apiBaseUrl2">http://localhost:8045</span>/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_API_KEY'
  },
  body: JSON.stringify({
    model: 'gemini-2.0-flash-exp',
    messages: [{ role: 'user', content: 'ä½ å¥½' }],
    stream: false
  })
});
const data = await response.json();
console.log(data);</div>
      </div>
    </div>

    <!-- æµ‹è¯•é¡µé¢ -->
    <div id="page-test" class="page-content">
      <div class="card">
        <h3>API æµ‹è¯•</h3>
        <p style="color: var(--gray); margin-bottom: 16px;">
          é€‰æ‹©æ¨¡å‹å¹¶å‘é€æµ‹è¯•æ¶ˆæ¯ï¼ŒéªŒè¯ API æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚
        </p>

        <div class="form-group">
          <label>é€‰æ‹©æ¨¡å‹</label>
          <div style="display: flex; gap: 10px;">
            <select id="testModel" style="flex: 1; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 0.95em;">
              <option value="">åŠ è½½ä¸­...</option>
            </select>
            <button onclick="loadModels()" class="btn-secondary" style="width: auto; padding: 12px 20px;">åˆ·æ–°</button>
          </div>
        </div>

        <div class="form-group">
          <label>æµ‹è¯•æ¶ˆæ¯</label>
          <textarea id="testMessage" rows="3" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼šä½ å¥½ï¼Œè¯·ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±" style="width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 0.95em; font-family: inherit; resize: vertical;">ä½ å¥½</textarea>
        </div>

        <div class="form-group">
          <label>æµå¼è¾“å‡º</label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="testStream" checked style="width: 18px; height: 18px;">
            <span style="color: var(--gray);">å¯ç”¨æµå¼å“åº” (SSE)</span>
          </label>
        </div>

        <button onclick="sendTestMessage()" class="btn-success" style="width: auto;">å‘é€æµ‹è¯•</button>
        <div id="testResult" style="margin-top: 20px;"></div>
      </div>

      <div class="card">
        <h3>å“åº”ç»“æœ</h3>
        <div id="testResponse" style="background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 12px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; line-height: 1.6; min-height: 200px; max-height: 500px; overflow-y: auto; white-space: pre-wrap; word-break: break-all;">
          <span style="color: #94a3b8;">ç­‰å¾…å‘é€æµ‹è¯•æ¶ˆæ¯...</span>
        </div>
      </div>
    </div>

    <!-- è®¾ç½®é¡µé¢ -->
    <div id="page-settings" class="page-content">
      <div class="card">
        <h3>è´¦æˆ·ä¿¡æ¯</h3>
        <div class="form-group">
          <label>ç”¨æˆ·å</label>
          <input type="text" id="settingsUsername" disabled style="background: #f1f5f9;">
        </div>
        <div class="form-group">
          <label>é‚®ç®±</label>
          <input type="email" id="settingsEmail" placeholder="è¯·è¾“å…¥é‚®ç®±">
        </div>
        <button onclick="updateProfile()" class="btn-secondary" style="width: auto;">æ›´æ–°ä¿¡æ¯</button>
        <div id="profileResult" style="margin-top: 15px;"></div>
      </div>

      <div class="card">
        <h3>ä¿®æ”¹å¯†ç </h3>
        <div class="form-group">
          <label>æ–°å¯†ç </label>
          <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
        </div>
        <div class="form-group">
          <label>ç¡®è®¤æ–°å¯†ç </label>
          <input type="password" id="confirmNewPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
        </div>
        <button onclick="changePassword()" class="btn-warning" style="width: auto; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">ä¿®æ”¹å¯†ç </button>
        <div id="passwordResult" style="margin-top: 15px;"></div>
      </div>

      <div class="card">
        <h3>ç³»ç»Ÿæç¤ºè¯</h3>
        <p style="color: var(--gray); margin-bottom: 16px;">
          è®¾ç½®æ‚¨çš„é»˜è®¤ç³»ç»Ÿæç¤ºè¯ï¼Œä½¿ç”¨æ‚¨çš„ API å¯†é’¥è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨æ·»åŠ åˆ°æ¯ä¸ªè¯·æ±‚ä¸­ã€‚ç•™ç©ºåˆ™ä¸æ·»åŠ ã€‚
        </p>
        <div class="form-group">
          <label>ç³»ç»Ÿæç¤ºè¯</label>
          <textarea id="systemPrompt" rows="6" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹ï¼Œè¯·ç”¨ç®€æ´æ¸…æ™°çš„æ–¹å¼å›ç­”é—®é¢˜..." style="width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 0.95em; font-family: inherit; resize: vertical;"></textarea>
        </div>
        <button onclick="updateSystemPrompt()" class="btn-secondary" style="width: auto;">ä¿å­˜æç¤ºè¯</button>
        <div id="systemPromptResult" style="margin-top: 15px;"></div>
      </div>

      <div class="card">
        <h3>è´¦æˆ·ç»Ÿè®¡</h3>
        <div class="stats-grid" style="margin-bottom: 0;">
          <div class="stat-card">
            <h4>æ³¨å†Œæ—¶é—´</h4>
            <div id="registerTime" style="font-size: 0.9em; color: var(--gray);">-</div>
          </div>
          <div class="stat-card">
            <h4>å¯†é’¥æ•°é‡</h4>
            <div class="stat-value" id="settingsKeyCount">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let userToken = localStorage.getItem('userToken') || '';
    let captchaAnswer = 0;

    // ç”ŸæˆéªŒè¯ç 
    function generateCaptcha() {
      const operators = ['+', '-', '*'];
      const operator = operators[Math.floor(Math.random() * operators.length)];
      let num1, num2, answer;

      switch (operator) {
        case '+':
          num1 = Math.floor(Math.random() * 20) + 1;
          num2 = Math.floor(Math.random() * 20) + 1;
          answer = num1 + num2;
          break;
        case '-':
          num1 = Math.floor(Math.random() * 20) + 10;
          num2 = Math.floor(Math.random() * 10) + 1;
          answer = num1 - num2;
          break;
        case '*':
          num1 = Math.floor(Math.random() * 9) + 1;
          num2 = Math.floor(Math.random() * 9) + 1;
          answer = num1 * num2;
          break;
      }

      captchaAnswer = answer;
      return `${num1} ${operator} ${num2} = ?`;
    }

    // åˆ·æ–°éªŒè¯ç 
    function refreshCaptcha() {
      const display = document.getElementById('captchaDisplay');
      if (display) {
        display.textContent = generateCaptcha();
        document.getElementById('regCaptcha').value = '';
      }
    }

    // æ˜¾ç¤ºæ³¨å†Œæ¡æ¬¾å¼¹çª—
    function showTermsModal() {
      document.getElementById('termsModal').classList.remove('hidden');
    }

    // å…³é—­æ³¨å†Œæ¡æ¬¾å¼¹çª—
    function closeTermsModal() {
      document.getElementById('termsModal').classList.add('hidden');
      // åˆ‡æ¢å›ç™»å½•æ ‡ç­¾
      switchAuthTab('login');
    }

    // æ¥å—æ¡æ¬¾
    function acceptTerms() {
      document.getElementById('agreeTerms').checked = true;
      document.getElementById('termsModal').classList.add('hidden');
    }

    // è·å–ç”¨æˆ·è®¤è¯å¤´
    function getUserHeaders() {
      return {
        'Content-Type': 'application/json',
        'X-User-Token': userToken
      };
    }


    // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ ‡ç­¾
    function switchAuthTab(tab, event) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

      // å¦‚æœæœ‰äº‹ä»¶å¯¹è±¡ï¼Œæ¿€æ´»ç‚¹å‡»çš„æ ‡ç­¾ï¼›å¦åˆ™é€šè¿‡ tab å‚æ•°æŸ¥æ‰¾å¯¹åº”æ ‡ç­¾
      if (event && event.target) {
        event.target.classList.add('active');
      } else {
        // é€šè¿‡ onclick å±æ€§æŸ¥æ‰¾å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
        const tabs = document.querySelectorAll('.auth-tab');
        tabs.forEach(t => {
          if (t.getAttribute('onclick').includes(`'${tab}'`)) {
            t.classList.add('active');
          }
        });
      }

      document.getElementById(tab + 'Form').classList.add('active');
      document.getElementById('authError').textContent = '';

      // åˆ‡æ¢åˆ°æ³¨å†Œæ—¶ç”ŸæˆéªŒè¯ç 
      if (tab === 'register') {
        refreshCaptcha();
      }
    }

    // ç”¨æˆ·ç™»å½•
    async function doUserLogin() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('authError');
      const btn = document.getElementById('loginBtn');

      if (!username || !password) {
        errorEl.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ç™»å½•ä¸­...';
      errorEl.textContent = '';

      try {
        const response = await fetch(`${API_BASE}/admin/user/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          userToken = data.token;
          localStorage.setItem('userToken', userToken);
          localStorage.setItem('username', data.user.username);
          document.getElementById('authOverlay').classList.add('hidden');
          loadUserData();
        } else {
          errorEl.textContent = data.error || 'ç™»å½•å¤±è´¥';
        }
      } catch (error) {
        errorEl.textContent = 'ç™»å½•å¤±è´¥: ' + error.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'ç™»å½•';
      }
    }

    // è·å–è®¾å¤‡ä¿¡æ¯
    function getDeviceInfo() {
      return {
        userAgent: navigator.userAgent,
        language: navigator.language,
        screen: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        platform: navigator.platform
      };
    }

    // ç”¨æˆ·æ³¨å†Œ
    async function doUserRegister() {
      const username = document.getElementById('regUsername').value;
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;
      const errorEl = document.getElementById('authError');
      const btn = document.getElementById('registerBtn');

      if (!username || !password) {
        errorEl.textContent = 'ç”¨æˆ·åå’Œå¯†ç æ˜¯å¿…å¡«é¡¹';
        return;
      }

      if (password !== confirmPassword) {
        errorEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
        return;
      }

      // éªŒè¯ç æ ¡éªŒ
      const captchaInput = document.getElementById('regCaptcha').value.trim();
      if (!captchaInput) {
        errorEl.textContent = 'è¯·è¾“å…¥éªŒè¯ç ';
        return;
      }

      if (parseInt(captchaInput) !== captchaAnswer) {
        errorEl.textContent = 'éªŒè¯ç é”™è¯¯';
        refreshCaptcha();
        return;
      }

      // æ£€æŸ¥æ˜¯å¦åŒæ„æ¡æ¬¾
      const agreeTerms = document.getElementById('agreeTerms').checked;
      if (!agreeTerms) {
        errorEl.textContent = 'è¯·é˜…è¯»å¹¶åŒæ„ç”¨æˆ·æ³¨å†Œåè®®';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'æ³¨å†Œä¸­...';
      errorEl.textContent = '';

      try {
        const response = await fetch(`${API_BASE}/admin/user/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username,
            password,
            email,
            deviceInfo: getDeviceInfo()
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // æ³¨å†ŒæˆåŠŸï¼Œè‡ªåŠ¨ç™»å½•
          errorEl.style.color = 'var(--success)';
          errorEl.textContent = 'æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨ç™»å½•...';

          document.getElementById('loginUsername').value = username;
          document.getElementById('loginPassword').value = password;

          // æ¸…ç©ºæ³¨å†Œè¡¨å•
          document.getElementById('regCaptcha').value = '';
          refreshCaptcha();

          switchAuthTab('login');
          setTimeout(() => doUserLogin(), 500);
        } else {
          errorEl.textContent = data.error || 'æ³¨å†Œå¤±è´¥';
          refreshCaptcha();
        }
      } catch (error) {
        errorEl.textContent = 'æ³¨å†Œå¤±è´¥: ' + error.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'æ³¨å†Œ';
      }
    }

    // ç”¨æˆ·ç™»å‡º
    async function doUserLogout() {
      try {
        await fetch(`${API_BASE}/admin/user/logout`, {
          method: 'POST',
          headers: getUserHeaders()
        });
      } catch (e) {}

      userToken = '';
      localStorage.removeItem('userToken');
      localStorage.removeItem('username');
      document.getElementById('authOverlay').classList.remove('hidden');
    }

    // éªŒè¯ä¼šè¯
    async function verifyUserSession() {
      if (!userToken) return false;

      try {
        const response = await fetch(`${API_BASE}/admin/user/verify`, {
          headers: { 'X-User-Token': userToken }
        });
        return response.ok;
      } catch (e) {
        return false;
      }
    }

    // åŠ è½½å…¬å‘Š
    async function loadAnnouncements() {
      try {
        const response = await fetch(`${API_BASE}/admin/announcements/active`);
        const announcements = await response.json();
        const container = document.getElementById('announcementContainer');

        if (!announcements || announcements.length === 0) {
          container.innerHTML = '';
          return;
        }

        container.innerHTML = announcements.map(ann => {
          const typeClass = ann.type !== 'info' ? `type-${ann.type}` : '';
          const pinnedClass = ann.pinned ? 'pinned' : '';
          const date = new Date(ann.created).toLocaleString();

          return `
            <div class="announcement ${typeClass} ${pinnedClass}">
              <div class="announcement-header">
                <div class="announcement-title">
                  ${ann.pinned ? '<span class="announcement-badge">ç½®é¡¶</span>' : ''}
                  ${ann.title}
                </div>
                <div class="announcement-time">${date}</div>
              </div>
              <div class="announcement-content">${ann.content.replace(/\n/g, '<br>')}</div>
              ${ann.images && ann.images.length > 0 ? `
                <div class="announcement-images">
                  ${ann.images.map(img => `
                    <img src="${img}" class="announcement-image" onclick="window.open('${img}', '_blank')" alt="å…¬å‘Šå›¾ç‰‡">
                  `).join('')}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('åŠ è½½å…¬å‘Šå¤±è´¥:', error);
      }
    }

    // åŠ è½½ç”¨æˆ·æ•°æ®
    async function loadUserData() {
      document.getElementById('displayUsername').textContent = localStorage.getItem('username') || 'ç”¨æˆ·';
      document.getElementById('apiBaseUrl').textContent = API_BASE;

      await loadAnnouncements();
      await loadKeys();
    }

    // åŠ è½½å¯†é’¥åˆ—è¡¨
    async function loadKeys() {
      try {
        const response = await fetch(`${API_BASE}/admin/user/keys`, {
          headers: getUserHeaders()
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const keys = await response.json();
        const container = document.getElementById('keyList');

        // æ›´æ–°ç»Ÿè®¡
        document.getElementById('keyCount').textContent = keys.length;
        let totalReqs = keys.reduce((sum, k) => sum + (k.requests || 0), 0);
        document.getElementById('totalRequests').textContent = totalReqs;

        if (keys.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>æš‚æ— å¯†é’¥</p>
              <p>ç‚¹å‡»ä¸Šæ–¹"ç”Ÿæˆå¯†é’¥"åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ª API å¯†é’¥</p>
            </div>
          `;
          return;
        }

        container.innerHTML = keys.map(key => `
          <div class="key-item">
            <div style="font-weight: 600; color: var(--dark);">${key.name}</div>
            <div class="key-value">${key.key}</div>
            <div class="key-meta">
              <div>
                <small>åˆ›å»ºæ—¶é—´: ${new Date(key.created).toLocaleString()}</small>
                ${key.lastUsed ? `<small style="margin-left: 15px;">ä¸Šæ¬¡ä½¿ç”¨: ${new Date(key.lastUsed).toLocaleString()}</small>` : ''}
                <small style="margin-left: 15px;">è¯·æ±‚æ¬¡æ•°: ${key.requests || 0}</small>
              </div>
              <div class="flex-buttons">
                <button class="copy-btn" onclick="copyToClipboard('${key.key}', this)">å¤åˆ¶</button>
                <button class="btn-danger" onclick="deleteKey('${key.id}')">åˆ é™¤</button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('åŠ è½½å¯†é’¥å¤±è´¥:', error);
      }
    }

    // ç”Ÿæˆå¯†é’¥
    async function generateKey() {
      const name = document.getElementById('keyName').value || 'æœªå‘½å';
      const resultEl = document.getElementById('generateResult');

      try {
        const response = await fetch(`${API_BASE}/admin/user/keys/generate`, {
          method: 'POST',
          headers: getUserHeaders(),
          body: JSON.stringify({ name })
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const data = await response.json();

        if (data.success) {
          resultEl.innerHTML = `
            <div class="alert alert-success">
              å¯†é’¥ç”ŸæˆæˆåŠŸï¼<br>
              <strong style="word-break: break-all;">${data.key.key}</strong><br>
              <small>è¯·å¦¥å–„ä¿å­˜ï¼Œæ­¤å¯†é’¥ä¸ä¼šå†æ¬¡å®Œæ•´æ˜¾ç¤ºï¼</small>
            </div>
          `;
          document.getElementById('keyName').value = '';
          loadKeys();
        } else {
          resultEl.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<div class="alert alert-error">ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
      }
    }

    // åˆ é™¤å¯†é’¥
    async function deleteKey(keyId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯†é’¥å—ï¼Ÿ')) return;

      try {
        const response = await fetch(`${API_BASE}/admin/user/keys/${keyId}`, {
          method: 'DELETE',
          headers: getUserHeaders()
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        if (response.ok) {
          loadKeys();
        } else {
          const data = await response.json();
          alert('åˆ é™¤å¤±è´¥: ' + data.error);
        }
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    async function copyToClipboard(text, button) {
      try {
        await navigator.clipboard.writeText(text);
        const originalText = button.textContent;
        button.textContent = 'å·²å¤åˆ¶!';
        button.classList.add('copied');

        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('copied');
        }, 2000);
      } catch (err) {
        alert('å¤åˆ¶å¤±è´¥');
      }
    }

    // åˆ‡æ¢é¡µé¢
    function switchPage(page) {
      // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // åˆ‡æ¢é¡µé¢å†…å®¹
      document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${page}`).classList.add('active');

      // åŠ è½½ç‰¹å®šé¡µé¢æ•°æ®
      if (page === 'keys') {
        loadKeys2();
      } else if (page === 'tokens') {
        loadUserTokens();
      } else if (page === 'docs') {
        loadModels();
        updateApiUrls();
      } else if (page === 'test') {
        loadModels();
      } else if (page === 'settings') {
        loadSettings();
      }
    }

    // å‘é€æµ‹è¯•æ¶ˆæ¯
    async function sendTestMessage() {
      const model = document.getElementById('testModel').value;
      const message = document.getElementById('testMessage').value.trim();
      const stream = document.getElementById('testStream').checked;
      const resultEl = document.getElementById('testResult');
      const responseEl = document.getElementById('testResponse');

      if (!model) {
        resultEl.innerHTML = '<div class="alert alert-error">è¯·é€‰æ‹©æ¨¡å‹</div>';
        return;
      }
      if (!message) {
        resultEl.innerHTML = '<div class="alert alert-error">è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯</div>';
        return;
      }

      // è·å–ç”¨æˆ·çš„ç¬¬ä¸€ä¸ª API å¯†é’¥
      const keys = await getUserApiKeys();
      if (!keys || keys.length === 0) {
        resultEl.innerHTML = '<div class="alert alert-error">è¯·å…ˆç”Ÿæˆä¸€ä¸ª API å¯†é’¥</div>';
        return;
      }
      const apiKey = keys[0].key;

      resultEl.innerHTML = '<div class="alert alert-info">æ­£åœ¨å‘é€è¯·æ±‚...</div>';
      responseEl.innerHTML = '<span style="color: #94a3b8;">è¯·æ±‚ä¸­...</span>';

      const requestBody = {
        model: model,
        messages: [{ role: 'user', content: message }],
        stream: stream
      };

      try {
        const startTime = Date.now();

        if (stream) {
          // æµå¼è¯·æ±‚
          const response = await fetch(window.location.origin + '/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify(requestBody)
          });

          if (!response.ok) {
            const error = await response.text();
            throw new Error('HTTP ' + response.status + ': ' + error);
          }

          responseEl.innerHTML = '';
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let fullContent = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (data === '[DONE]') continue;
                try {
                  const json = JSON.parse(data);
                  const content = json.choices?.[0]?.delta?.content || '';
                  if (content) {
                    fullContent += content;
                    responseEl.textContent = fullContent;
                    responseEl.scrollTop = responseEl.scrollHeight;
                  }
                } catch (e) {
                  // å¿½ç•¥è§£æé”™è¯¯
                }
              }
            }
          }

          const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
          resultEl.innerHTML = '<div class="alert alert-success">è¯·æ±‚æˆåŠŸï¼è€—æ—¶: ' + elapsed + 's</div>';
        } else {
          // éæµå¼è¯·æ±‚
          const response = await fetch(window.location.origin + '/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify(requestBody)
          });

          const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);

          if (!response.ok) {
            const error = await response.text();
            throw new Error('HTTP ' + response.status + ': ' + error);
          }

          const data = await response.json();
          const content = data.choices?.[0]?.message?.content || JSON.stringify(data, null, 2);
          responseEl.textContent = content;
          resultEl.innerHTML = '<div class="alert alert-success">è¯·æ±‚æˆåŠŸï¼è€—æ—¶: ' + elapsed + 's</div>';
        }
      } catch (error) {
        resultEl.innerHTML = '<div class="alert alert-error">è¯·æ±‚å¤±è´¥: ' + error.message + '</div>';
        responseEl.innerHTML = '<span style="color: #ef4444;">' + error.message + '</span>';
      }
    }

    // è·å–ç”¨æˆ· API å¯†é’¥
    async function getUserApiKeys() {
      try {
        const response = await fetch(API_BASE + '/admin/user/keys', {
          headers: { 'X-User-Token': userToken }
        });
        if (response.ok) {
          return await response.json();
        }
      } catch (e) {}
      return [];
    }

    // æ·»åŠ  Google Token
    async function addGoogleToken() {
      try {
        // ä»æœåŠ¡ç«¯è·å– OAuth é…ç½®ï¼ˆå…¬å¼€æ¥å£ï¼Œä¸éœ€è¦ç™»å½•ï¼‰
        const configResponse = await fetch(`${API_BASE}/admin/oauth-config`);
        const config = await configResponse.json();

        if (!config.clientId) {
          alert('OAuth æœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åœ¨ç³»ç»Ÿè®¾ç½®ä¸­é…ç½® Google OAuth');
          return;
        }

        const clientId = config.clientId;
        const redirectUri = `${API_BASE}/admin/oauth-callback`;
        const scope = [
          'https://www.googleapis.com/auth/cloud-platform',
          'https://www.googleapis.com/auth/userinfo.email',
          'https://www.googleapis.com/auth/userinfo.profile',
          'https://www.googleapis.com/auth/cclog',
          'https://www.googleapis.com/auth/experimentsandconfigs'
        ].join(' ');

        const params = new URLSearchParams({
          client_id: clientId,
          redirect_uri: redirectUri,
          response_type: 'code',
          scope: scope,
          access_type: 'offline',
          prompt: 'consent'
        });

        // ä¿å­˜å½“å‰ userToken ä»¥ä¾¿å›è°ƒåæ¢å¤
        localStorage.setItem('userTokenTemp', userToken);
        window.location.href = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
      } catch (error) {
        alert('è·å– OAuth é…ç½®å¤±è´¥: ' + error.message);
      }
    }

    // ä»å›è°ƒé“¾æ¥æ·»åŠ  Token
    async function addTokenFromCallback() {
      const callbackUrl = document.getElementById('callbackUrl').value.trim();
      const resultEl = document.getElementById('callbackResult');

      if (!callbackUrl) {
        resultEl.innerHTML = '<div class="alert alert-error">è¯·è¾“å…¥å›è°ƒé“¾æ¥</div>';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/user/tokens/callback`, {
          method: 'POST',
          headers: getUserHeaders(),
          body: JSON.stringify({ callback_url: callbackUrl })
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const data = await response.json();

        if (data.success) {
          resultEl.innerHTML = '<div class="alert alert-success">Token æ·»åŠ æˆåŠŸï¼</div>';
          document.getElementById('callbackUrl').value = '';
          loadUserTokens();
        } else {
          resultEl.innerHTML = `<div class="alert alert-error">${data.error || 'Token æ·»åŠ å¤±è´¥'}</div>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<div class="alert alert-error">æ·»åŠ å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½ç”¨æˆ· Token åˆ—è¡¨
    async function loadUserTokens() {
      try {
        const response = await fetch(`${API_BASE}/admin/user/tokens`, {
          headers: getUserHeaders()
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const tokens = await response.json();
        const container = document.getElementById('tokenList');

        // æ›´æ–° Token ç»Ÿè®¡
        const sharedCount = tokens.filter(t => t.isShared).length;
        const totalSharedUsage = tokens.filter(t => t.isShared).reduce((sum, t) => sum + (t.usageToday || 0), 0);

        document.getElementById('tokenCount').textContent = tokens.length;
        document.getElementById('sharedTokenCount').textContent = sharedCount;
        document.getElementById('sharedUsageToday').textContent = totalSharedUsage;

        if (tokens.length === 0) {
          // è®¾ç½®ç»Ÿè®¡ä¸º 0
          document.getElementById('tokenCount').textContent = '0';
          document.getElementById('sharedTokenCount').textContent = '0';
          document.getElementById('sharedUsageToday').textContent = '0';

          container.innerHTML = `
            <div class="empty-state">
              <p>æš‚æ—  Token</p>
              <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ª Google Token</p>
            </div>
          `;
          return;
        }

        container.innerHTML = tokens.map((token, index) => `
          <div class="key-item">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div style="font-weight: 600; color: var(--dark);">${token.email || 'Token #' + (index + 1)}</div>
              <div style="display: flex; gap: 8px; align-items: center;">
                ${token.isShared ? `<span style="padding: 4px 8px; border-radius: 6px; font-size: 0.85em; background: #dbeafe; color: #1e40af;">
                  å·²å…±äº« (${token.usageToday || 0}/${token.dailyLimit || 100})
                </span>` : ''}
                <span style="padding: 4px 8px; border-radius: 6px; font-size: 0.85em; ${token.enable ? 'background: #d1fae5; color: #065f46;' : 'background: #fee2e2; color: #991b1b;'}">
                  ${token.enable ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
                </span>
              </div>
            </div>
            <div class="key-value">Access Token: ${token.access_token.substring(0, 30)}...</div>
            ${token.refresh_token ? `<div class="key-value">Refresh Token: ${token.refresh_token.substring(0, 30)}...</div>` : ''}

            <!-- å…±äº«è®¾ç½® -->
            <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin: 10px 0; border: 1px solid var(--border);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="margin: 0; display: flex; align-items: center; cursor: pointer;">
                  <input type="checkbox" id="share-${index}" ${token.isShared ? 'checked' : ''}
                    onchange="toggleTokenSharing(${index}, this.checked)"
                    style="width: auto; margin-right: 8px; cursor: pointer;">
                  <span style="font-weight: 600; color: var(--dark);">å…±äº«æ­¤ Token</span>
                </label>
              </div>
              ${token.isShared || true ? `
              <div style="display: flex; gap: 10px; align-items: center;">
                <label style="margin: 0; font-size: 0.9em; color: var(--gray);">æ¯æ—¥é™åˆ¶:</label>
                <input type="number" id="limit-${index}" value="${token.dailyLimit || 100}"
                  min="1" max="10000"
                  style="width: 120px; padding: 6px 10px; font-size: 0.9em;"
                  onchange="updateDailyLimit(${index}, this.value)">
                <small style="color: var(--gray);">æ¬¡/å¤©</small>
                ${token.isShared ? `<small style="color: var(--info); margin-left: 10px;">ä»Šæ—¥å·²ç”¨: ${token.usageToday || 0} æ¬¡</small>` : ''}
              </div>
              ` : ''}
            </div>

            <div class="key-meta">
              <div>
                <small>æ·»åŠ æ—¶é—´: ${new Date(token.timestamp).toLocaleString()}</small>
                <small style="margin-left: 15px;">è¿‡æœŸæ—¶é—´: ${token.expires_in}ç§’</small>
              </div>
              <div class="flex-buttons">
                <button class="btn-danger" onclick="deleteUserToken(${index})">åˆ é™¤</button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('åŠ è½½ Token å¤±è´¥:', error);
      }
    }

    // æ‰‹åŠ¨æ·»åŠ  Token
    async function addManualToken() {
      const accessToken = document.getElementById('manualAccessToken').value.trim();
      const refreshToken = document.getElementById('manualRefreshToken').value.trim();
      const expiresIn = parseInt(document.getElementById('manualExpiresIn').value) || 3600;
      const resultEl = document.getElementById('manualTokenResult');

      if (!accessToken) {
        resultEl.innerHTML = '<div class="alert alert-error">è¯·è¾“å…¥ Access Token</div>';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/user/tokens/direct`, {
          method: 'POST',
          headers: getUserHeaders(),
          body: JSON.stringify({
            access_token: accessToken,
            refresh_token: refreshToken || null,
            expires_in: expiresIn
          })
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const data = await response.json();

        if (data.success) {
          resultEl.innerHTML = '<div class="alert alert-success">Token æ·»åŠ æˆåŠŸï¼</div>';
          document.getElementById('manualAccessToken').value = '';
          document.getElementById('manualRefreshToken').value = '';
          document.getElementById('manualExpiresIn').value = '3600';
          loadUserTokens();
        } else {
          resultEl.innerHTML = `<div class="alert alert-error">${data.error || 'Token æ·»åŠ å¤±è´¥'}</div>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<div class="alert alert-error">æ·»åŠ å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åˆ é™¤ç”¨æˆ· Token
    async function deleteUserToken(index) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª Token å—ï¼Ÿ')) return;

      try {
        const response = await fetch(`${API_BASE}/admin/user/tokens/${index}`, {
          method: 'DELETE',
          headers: getUserHeaders()
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const data = await response.json();

        if (data.success) {
          loadUserTokens();
        } else {
          alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // åˆ‡æ¢ Token å…±äº«çŠ¶æ€
    async function toggleTokenSharing(index, isShared) {
      try {
        const dailyLimit = parseInt(document.getElementById(`limit-${index}`).value) || 100;

        const response = await fetch(`${API_BASE}/admin/user/tokens/${index}/sharing`, {
          method: 'PATCH',
          headers: getUserHeaders(),
          body: JSON.stringify({ isShared, dailyLimit })
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const data = await response.json();

        if (data.success) {
          loadUserTokens();
        } else {
          alert('æ›´æ–°å…±äº«è®¾ç½®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
          loadUserTokens(); // æ¢å¤åŸçŠ¶
        }
      } catch (error) {
        alert('æ›´æ–°å…±äº«è®¾ç½®å¤±è´¥: ' + error.message);
        loadUserTokens(); // æ¢å¤åŸçŠ¶
      }
    }

    // æ›´æ–°æ¯æ—¥é™åˆ¶
    async function updateDailyLimit(index, dailyLimit) {
      const isShared = document.getElementById(`share-${index}`).checked;

      try {
        const response = await fetch(`${API_BASE}/admin/user/tokens/${index}/sharing`, {
          method: 'PATCH',
          headers: getUserHeaders(),
          body: JSON.stringify({ isShared, dailyLimit: parseInt(dailyLimit) })
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const data = await response.json();

        if (!data.success) {
          alert('æ›´æ–°æ¯æ—¥é™åˆ¶å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
          loadUserTokens(); // æ¢å¤åŸçŠ¶
        }
      } catch (error) {
        alert('æ›´æ–°æ¯æ—¥é™åˆ¶å¤±è´¥: ' + error.message);
        loadUserTokens(); // æ¢å¤åŸçŠ¶
      }
    }

    // æ›´æ–° API URLs
    function updateApiUrls() {
      document.querySelectorAll('.apiBaseUrl2').forEach(el => {
        el.textContent = API_BASE;
      });
    }

    // åŠ è½½å¯†é’¥åˆ—è¡¨ï¼ˆå¯†é’¥ç®¡ç†é¡µé¢ï¼‰
    async function loadKeys2() {
      try {
        const response = await fetch(`${API_BASE}/admin/user/keys`, {
          headers: getUserHeaders()
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const keys = await response.json();
        const container = document.getElementById('keyList2');

        if (keys.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>æš‚æ— å¯†é’¥</p>
            </div>
          `;
          return;
        }

        container.innerHTML = keys.map(key => `
          <div class="key-item">
            <div style="font-weight: 600; color: var(--dark);">${key.name}</div>
            <div class="key-value">${key.key}</div>
            <div class="key-meta">
              <div>
                <small>åˆ›å»ºæ—¶é—´: ${new Date(key.created).toLocaleString()}</small>
                ${key.lastUsed ? `<small style="margin-left: 15px;">ä¸Šæ¬¡ä½¿ç”¨: ${new Date(key.lastUsed).toLocaleString()}</small>` : ''}
                <small style="margin-left: 15px;">è¯·æ±‚æ¬¡æ•°: ${key.requests || 0}</small>
              </div>
              <div class="flex-buttons">
                <button class="copy-btn" onclick="copyToClipboard('${key.key}', this)">å¤åˆ¶</button>
                <button class="btn-danger" onclick="deleteKey('${key.id}')">åˆ é™¤</button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('åŠ è½½å¯†é’¥å¤±è´¥:', error);
      }
    }

    // ç”Ÿæˆå¯†é’¥ï¼ˆå¯†é’¥ç®¡ç†é¡µé¢ï¼‰
    async function generateKey2() {
      const name = document.getElementById('keyName2').value || 'æœªå‘½å';
      const resultEl = document.getElementById('generateResult2');

      try {
        const response = await fetch(`${API_BASE}/admin/user/keys/generate`, {
          method: 'POST',
          headers: getUserHeaders(),
          body: JSON.stringify({ name })
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const data = await response.json();

        if (data.success) {
          resultEl.innerHTML = `
            <div class="alert alert-success">
              å¯†é’¥ç”ŸæˆæˆåŠŸï¼<br>
              <strong style="word-break: break-all;">${data.key.key}</strong><br>
              <small>è¯·å¦¥å–„ä¿å­˜ï¼Œæ­¤å¯†é’¥ä¸ä¼šå†æ¬¡å®Œæ•´æ˜¾ç¤ºï¼</small>
            </div>
          `;
          document.getElementById('keyName2').value = '';
          loadKeys2();
          loadKeys(); // åŒæ—¶åˆ·æ–°é¦–é¡µ
        } else {
          resultEl.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<div class="alert alert-error">ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½æ¨¡å‹åˆ—è¡¨
    async function loadModels() {
      try {
        // è·å–ç”¨æˆ·çš„ API Key ç”¨äºè®¤è¯
        const keys = await getUserApiKeys();
        const apiKey = keys && keys.length > 0 ? keys[0].key : null;

        const headers = {};
        if (apiKey) {
          headers['Authorization'] = 'Bearer ' + apiKey;
        }

        const response = await fetch(window.location.origin + '/v1/models', { headers });
        const data = await response.json();

        // æ›´æ–° API æ–‡æ¡£é¡µé¢çš„æ¨¡å‹åˆ—è¡¨
        const container = document.getElementById('modelList');
        if (container) {
          if (data.data && data.data.length > 0) {
            container.innerHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">' +
              data.data.map(function(model) {
                return '<div style="background: #f8f9fa; padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border);">' +
                  '<div style="font-weight: 600; color: var(--dark); font-size: 0.9em;">' + model.id + '</div>' +
                '</div>';
              }).join('') +
            '</div>';
          } else {
            container.innerHTML = '<p style="color: var(--gray);">æš‚æ— å¯ç”¨æ¨¡å‹</p>';
          }
        }

        // æ›´æ–°æµ‹è¯•é¡µé¢çš„æ¨¡å‹é€‰æ‹©å™¨
        const testModelSelect = document.getElementById('testModel');
        if (testModelSelect) {
          if (data.data && data.data.length > 0) {
            testModelSelect.innerHTML = data.data.map(function(model) {
              return '<option value="' + model.id + '">' + model.id + '</option>';
            }).join('');
          } else {
            testModelSelect.innerHTML = '<option value="">æš‚æ— å¯ç”¨æ¨¡å‹</option>';
          }
        }
      } catch (error) {
        const container = document.getElementById('modelList');
        if (container) {
          container.innerHTML = '<p style="color: var(--danger);">åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + error.message + '</p>';
        }
        const testModelSelect = document.getElementById('testModel');
        if (testModelSelect) {
          testModelSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        }
      }
    }

    // åŠ è½½ç”¨æˆ·è®¾ç½®
    async function loadSettings() {
      try {
        const response = await fetch(`${API_BASE}/admin/user/profile`, {
          headers: getUserHeaders()
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const user = await response.json();

        document.getElementById('settingsUsername').value = user.username || '';
        document.getElementById('settingsEmail').value = user.email || '';
        document.getElementById('systemPrompt').value = user.systemPrompt || '';
        document.getElementById('registerTime').textContent = user.created ? new Date(user.created).toLocaleString() : '-';

        // åŠ è½½å¯†é’¥æ•°é‡
        const keysResponse = await fetch(`${API_BASE}/admin/user/keys`, {
          headers: getUserHeaders()
        });
        const keys = await keysResponse.json();
        document.getElementById('settingsKeyCount').textContent = keys.length;
      } catch (error) {
        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
      }
    }

    // æ›´æ–°ä¸ªäººä¿¡æ¯
    async function updateProfile() {
      const email = document.getElementById('settingsEmail').value;
      const resultEl = document.getElementById('profileResult');

      try {
        const response = await fetch(`${API_BASE}/admin/user/profile`, {
          method: 'PATCH',
          headers: getUserHeaders(),
          body: JSON.stringify({ email })
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const data = await response.json();

        if (data.success) {
          resultEl.innerHTML = '<div class="alert alert-success">ä¿¡æ¯æ›´æ–°æˆåŠŸï¼</div>';
        } else {
          resultEl.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<div class="alert alert-error">æ›´æ–°å¤±è´¥: ${error.message}</div>`;
      }
    }

    // ä¿®æ”¹å¯†ç 
    async function changePassword() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmNewPassword').value;
      const resultEl = document.getElementById('passwordResult');

      if (!newPassword) {
        resultEl.innerHTML = '<div class="alert alert-error">è¯·è¾“å…¥æ–°å¯†ç </div>';
        return;
      }

      if (newPassword !== confirmPassword) {
        resultEl.innerHTML = '<div class="alert alert-error">ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</div>';
        return;
      }

      if (newPassword.length < 6) {
        resultEl.innerHTML = '<div class="alert alert-error">å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦</div>';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/user/profile`, {
          method: 'PATCH',
          headers: getUserHeaders(),
          body: JSON.stringify({ password: newPassword })
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const data = await response.json();

        if (data.success) {
          resultEl.innerHTML = '<div class="alert alert-success">å¯†ç ä¿®æ”¹æˆåŠŸï¼</div>';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmNewPassword').value = '';
        } else {
          resultEl.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<div class="alert alert-error">ä¿®æ”¹å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æ›´æ–°ç³»ç»Ÿæç¤ºè¯
    async function updateSystemPrompt() {
      const systemPrompt = document.getElementById('systemPrompt').value.trim();
      const resultEl = document.getElementById('systemPromptResult');

      try {
        const response = await fetch(`${API_BASE}/admin/user/profile`, {
          method: 'PATCH',
          headers: getUserHeaders(),
          body: JSON.stringify({ systemPrompt: systemPrompt || null })
        });

        if (response.status === 401) {
          doUserLogout();
          return;
        }

        const data = await response.json();

        if (data.success) {
          resultEl.innerHTML = '<div class="alert alert-success">ç³»ç»Ÿæç¤ºè¯ä¿å­˜æˆåŠŸï¼</div>';
          setTimeout(() => {
            resultEl.innerHTML = '';
          }, 3000);
        } else {
          resultEl.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        }
      } catch (error) {
        resultEl.innerHTML = `<div class="alert alert-error">ä¿å­˜å¤±è´¥: ${error.message}</div>`;
      }
    }

    // é¡µé¢åŠ è½½
    document.addEventListener('DOMContentLoaded', async () => {
      // åˆå§‹åŒ–éªŒè¯ç 
      refreshCaptcha();

      const isLoggedIn = await verifyUserSession();
      if (isLoggedIn) {
        document.getElementById('authOverlay').classList.add('hidden');
        loadUserData();
      }
    });
  </script>
</body>
</html>
